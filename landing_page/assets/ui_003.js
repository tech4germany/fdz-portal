(function($){$.widget("aperto.gallery",{options:{srcAttribute:"href",openerSel:"dl.photo a",openerWrapper:"dl.photo",getTextContent:function(opener,content,ui){content["text-content"]=$("dd",$(opener).closest("dl")).html();},selectedIndex:0,showContentAnim:function(ui,img,e,extras){var content=$('<div class="gallery-stage-box"><div class="multimedia-box"></div><div class="multimedia-description">'+ui.content["text-content"]+"</div></div>").find("div.multimedia-box").html(img).end();img=content.find("img");$("div.gallery-stage",ui.element).append(content.css({opacity:0}));img.css($.objScale.constrainObjTo(img,content.find("div.multimedia-box")));content.fadeTo(300,1);},hideContentAnim:function(ui,e,extras){if(extras.oldAnchor){$("div.gallery-stage-box",ui.element).fadeOut(300,function(){$(this).remove();});}}},_create:function(){this._getMarkupOptions();var o=this.options,that=this;this.openers=$(o.openerSel,this.element);$.createUrlIndex(this.openers,this);this.openers.bind("click",function(e){that._loadOpener(e);return false;});this._trigger("init",{},{instance:this});this.element.bind("galleryindexchange",$.proxy(this,"markactive"));this._loadOpener({currentTarget:this.openers.eq(o.selectedIndex)[0]});},markactive:function(e,data){var wrapper=this.options.openerWrapper;data.opener.closest(wrapper).addClass("js-active");if(data.oldAnchor){data.oldAnchor.closest(wrapper).removeClass("js-active");}},_loadOpener:function(e){if(!e||!e.currentTarget){return;}this.loadIndex($(e.currentTarget).attr(this.options.srcAttribute));return false;},ui:function(ext){return $.extend({},{instance:this},ext);}});$.widget("aperto.galleryshowbox",{options:{scroller:"div.img-group",addScroller:true,scrollerOpts:{hidingWrapper:"div.ig-box",moveWrapper:"div.ig-box-design",atoms:"dl.photo"},showboxOpts:{},galleryOpts:{getTextContent:function(opener,content,ui){var dl=opener.closest("dl"),dds=$("dd",dl),img=$("img",dl),extraContent="";content["multimedia-box"].attr("alt",img.attr("alt"));content["text-content"]="";dds.each(function(){var dd=$(this),html=dd.html();if(dd.is(".caption")){content["text-content"]+='<h2 class="caption">'+html+"</h2>";content["showbox-title"]=html;}else{if(dd.is(".longdesc")){content["text-content"]+='<p class="longdesc">'+html+"</p>";}else{if(!dd.is(".zoom")){extraContent+='<li class="'+this.className+'">'+html+"</li>";}}}});if(extraContent){content["text-content"]+='<ul class="sb-extra">'+extraContent+"</ul>";}},openerWrapper:"dl.photo"},openOnImgClick:true,zoomElm:".showbox-opener",immediateScrollerApply:true},_create:function(){this._getMarkupOptions();var o=this.options;var that=this;var showboxOverlay;var showBoxOpeners;o.galleryOpts=$.extend(true,{},$.aperto.gallery.prototype.options,o.galleryOpts);if($.fn.showbox){o.showboxOpts=$.extend(true,{},$.fn.showbox.defaults,o.showboxOpts);}else{alert("there is no showbox");}if($.ui.scroller&&o.addScroller){o.scrollerOpts=$.extend({},$.ui.scroller.prototype.options,o.scrollerOpts);}else{if(o.addScroller){alert("there is no scroller");}}showboxOverlay=$(o.showboxOpts.structure);if(o.addScroller===true||o.addScroller==="showbox"){$("div.content-box",showboxOverlay).append($(o.scroller,this.element).clone());}$(".showbox-opener",this.element).each(function(){if($.nodeName(this,"a")&&$.support.waiAria){$(this).attr({role:"button",tabindex:0}).removeAttr("href");}}).bind("ariaclick",$.proxy(this,"openShowBox"));this.galleryInstance=$.data(this.element.gallery(o.galleryOpts)[0],"gallery");if(o.addScroller===true||o.addScroller==="showbox"){showBoxOpeners=$(o.galleryOpts.openerSel,showboxOverlay).bind("ariaclick",function(e){if(that.showboxInstance.isVisible){that.showboxInstance.loadIndex($(e.currentTarget).attr("href"),e);e.stopImmediatePropagation();return false;}});}else{showBoxOpeners=$(o.galleryOpts.openerSel,this.element);o.showboxOpts.openEvent="openlightbox";}showBoxOpeners.showbox($.extend(o.showboxOpts,{structure:showboxOverlay,getTextContent:o.showboxOpts.getTextContent||o.galleryOpts.getTextContent}));this.showboxInstance=showboxOverlay.data("cOverlay");if(o.openOnImgClick){this.element.delegate("div.multimedia-box > img","click",function(){that.openShowBox.apply(that,arguments);});}if(o.addScroller){if(o.addScroller===true||o.addScroller=="gallery"){this.scrollerInstance=$(o.scroller,this.element).scroller(o.scrollerOpts).data("scroller");}if(o.addScroller===true||o.addScroller=="showbox"){this.bindShowBoxScroller($(o.scroller,showboxOverlay).scroller(o.scrollerOpts));}}},markactive:$.aperto.gallery.prototype.markactive,bindShowBoxScroller:function(showboxScroller){var timer,i;var that=this;var o=that.options;var stopTimer=function(){clearInterval(timer);i=0;};var showbox=this.showboxInstance.element.bind("coverlayshow coverlayindexchange",function(e,data){if(e.type==="coverlayindexchange"&&o.addScroller&&o.immediateScrollerApply){that.galleryInstance.loadIndex(that.showboxInstance.currentIndex);}stopTimer();showboxScroller.scroller("stageWidthUpdate");if(e.type=="coverlayindexchange"){that.markactive(e,data);}timer=setInterval(function(){var changedSize=showboxScroller.scroller("update",true);if(i>8&&!changedSize){stopTimer();}if(i>40){stopTimer();}i++;},90);});},openShowBox:function(e){var opener=this.showboxInstance.uniqueOpeners.filter(":eq("+this.galleryInstance.currentIndex+")");opener.trigger(this.options.showboxOpts.openEvent||"click");return false;}});})(jQuery);